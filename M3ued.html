<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U প্লেয়ার উইথ চ্যানেল লিস্ট</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            flex-direction: column;
            align-items: center;
        }
        .container {
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 1200px;
            gap: 20px;
        }
        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 20px;
        }
        .top-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .player-section {
            flex: 2;
            min-width: 400px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        .channel-list-section {
            flex: 1;
            min-width: 300px;
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 80vh;
        }
        #video-player {
            width: 100%;
            height: auto;
            border-radius: 8px;
            background-color: #000;
        }
        .controls {
            margin-top: 20px;
            text-align: center;
        }
        input[type="file"] {
            border: 2px solid #ddd;
            padding: 0.5rem;
            border-radius: 6px;
            width: 100%;
            box-sizing: border-box;
            background: #f9f9f9;
        }
        .btn {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-success:hover {
            background-color: #218838;
        }
        .btn-info {
            background-color: #17a2b8;
        }
        .btn-info:hover {
            background-color: #138496;
        }
        .btn-primary {
            background-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0069d9;
        }
        .btn:hover {
            background-color: #0056b3;
        }
        .channel-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        .channel-item:hover {
            background-color: #f0f0f0;
        }
        .channel-item.playing {
            background-color: #e0f7fa;
        }
        .channel-item.working {
            background-color: #e6ffed;
        }
        .channel-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            border: 1px solid #ddd;
        }
        .channel-item .channel-info {
            flex-grow: 1;
        }
        .channel-item .channel-info h3 {
            margin: 0;
            font-size: 1rem;
        }
        .channel-item .channel-actions {
            display: flex;
            gap: 5px;
        }
        .channel-item .action-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 8px 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            font-size: 0.8rem;
        }
        .channel-item .action-button.delete {
            background-color: #dc3545;
        }
        .channel-item .action-button.delete:hover {
            background-color: #c82333;
        }
        .channel-item .action-button.download {
            background-color: #17a2b8;
        }
        .channel-item .action-button.download:hover {
            background-color: #138496;
        }
        .channel-item .action-button.play {
            background-color: #007bff;
        }
        .channel-item .action-button.play:hover {
            background-color: #0056b3;
        }
        .channel-item .action-button.move {
            background-color: #6c757d;
            padding: 8px 8px;
        }
        .channel-item .action-button.move:hover {
            background-color: #5a6268;
        }
        .empty-list-msg {
            text-align: center;
            color: #666;
            margin-top: 20px;
        }
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            .top-controls {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>M3U প্লেয়ার উইথ চ্যানেল লিস্ট</h1>
    <div class="top-controls">
        <button id="auto-play-btn" class="btn btn-info" style="display:none;">অটো প্লে শুরু করুন</button>
        <button id="download-working-btn" class="btn btn-success" style="display:none;">সচল চ্যানেল ডাউনলোড করুন (M3U)</button>
        <button id="download-all-btn" class="btn btn-primary" style="display:none;">অবশিষ্ট চ্যানেল ডাউনলোড করুন (M3U)</button>
    </div>
    <div class="main-content">
        <div class="player-section">
            <video id="video-player" controls></video>
            <div class="controls">
                <p>একটি M3U বা M3U8 ফাইল আপলোড করুন।</p>
                <input type="file" id="file-input" accept=".m3u,.m3u8">
                <button id="load-btn" class="btn">চ্যানেল লোড করুন</button>
            </div>
        </div>
        <div class="channel-list-section">
            <h2>চ্যানেল তালিকা</h2>
            <div id="channel-list">
                <p class="empty-list-msg">দয়া করে একটি M3U ফাইল আপলোড করুন।</p>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
    const fileInput = document.getElementById('file-input');
    const loadBtn = document.getElementById('load-btn');
    const channelListDiv = document.getElementById('channel-list');
    const videoPlayer = document.getElementById('video-player');
    const autoPlayBtn = document.getElementById('auto-play-btn');
    const downloadWorkingBtn = document.getElementById('download-working-btn');
    const downloadAllBtn = document.getElementById('download-all-btn');

    let allChannels = [];
    let workingChannels = [];
    let currentPlayingIndex = -1;
    let hls = null;

    loadBtn.addEventListener('click', function() {
        const file = fileInput.files[0];
        if (!file) {
            alert('দয়া করে একটি ফাইল নির্বাচন করুন।');
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const m3uContent = event.target.result;
            parseM3U(m3uContent);
        };
        reader.readAsText(file);
    });

    autoPlayBtn.addEventListener('click', function() {
        if (workingChannels.length === 0) {
            alert('কোনো সচল চ্যানেল পাওয়া যায়নি।');
            return;
        }
        if (autoPlayBtn.textContent === 'অটো প্লে শুরু করুন') {
            autoPlayBtn.textContent = 'অটো প্লে বন্ধ করুন';
            currentPlayingIndex = 0;
            playChannel(workingChannels[currentPlayingIndex]);
            videoPlayer.addEventListener('ended', playNextChannel);
            videoPlayer.addEventListener('error', playNextChannel);
        } else {
            autoPlayBtn.textContent = 'অটো প্লে শুরু করুন';
            videoPlayer.removeEventListener('ended', playNextChannel);
            videoPlayer.removeEventListener('error', playNextChannel);
            if (hls) {
                hls.destroy();
                hls = null;
            }
            videoPlayer.src = '';
        }
    });

    downloadWorkingBtn.addEventListener('click', function() {
        if (workingChannels.length === 0) {
            alert('ডাউনলোড করার জন্য কোনো সচল চ্যানেল নেই।');
            return;
        }

        let m3uContent = '#EXTM3U\n';
        workingChannels.forEach(channel => {
            m3uContent += `#EXTINF:-1 tvg-id="" tvg-logo="${channel.logo}",${channel.name}\n`;
            m3uContent += `${channel.url}\n`;
        });

        const blob = new Blob([m3uContent], { type: 'audio/mpegurl' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'working_channels.m3u';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    downloadAllBtn.addEventListener('click', function() {
        if (allChannels.length === 0) {
            alert('ডাউনলোড করার জন্য কোনো অবশিষ্ট চ্যানেল নেই।');
            return;
        }

        let m3uContent = '#EXTM3U\n';
        allChannels.forEach(channel => {
            m3uContent += `#EXTINF:-1 tvg-id="" tvg-logo="${channel.logo}",${channel.name}\n`;
            m3uContent += `${channel.url}\n`;
        });

        const blob = new Blob([m3uContent], { type: 'audio/mpegurl' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'remaining_channels.m3u';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });

    function parseM3U(content) {
        const lines = content.split('\n');
        allChannels = [];
        let currentChannel = {};

        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (line.startsWith('#EXTINF:')) {
                const tvgLogoMatch = line.match(/tvg-logo="([^"]*)"/);
                const channelNameMatch = line.match(/,(.*)/);
                
                currentChannel.name = channelNameMatch ? channelNameMatch[1].trim() : 'Unknown Channel';
                currentChannel.logo = tvgLogoMatch ? tvgLogoMatch[1] : '';
            } else if (line.startsWith('http')) {
                currentChannel.url = line;
                allChannels.push(currentChannel);
                currentChannel = {};
            }
        }
        displayChannels(allChannels);
    }
    
    function displayChannels(channels) {
        channelListDiv.innerHTML = '';
        if (channels.length === 0) {
            channelListDiv.innerHTML = '<p class="empty-list-msg">এই ফাইলে কোনো চ্যানেল পাওয়া যায়নি।</p>';
            autoPlayBtn.style.display = 'none';
            downloadWorkingBtn.style.display = 'none';
            downloadAllBtn.style.display = 'none';
            return;
        }

        workingChannels = [];
        channels.forEach((channel, index) => {
            const channelItem = document.createElement('div');
            channelItem.className = 'channel-item';
            channelItem.dataset.name = channel.name;
            
            const logo = document.createElement('img');
            logo.src = channel.logo || 'https://via.placeholder.com/40';
            logo.alt = `${channel.name} logo`;
            
            const channelInfo = document.createElement('div');
            channelInfo.className = 'channel-info';
            const channelName = document.createElement('h3');
            channelName.textContent = channel.name;
            channelInfo.appendChild(channelName);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'channel-actions';

            const playButton = document.createElement('button');
            playButton.className = 'action-button play';
            playButton.textContent = 'প্লে';
            playButton.addEventListener('click', () => {
                playChannel(channel);
            });

            const deleteButton = document.createElement('button');
            deleteButton.className = 'action-button delete';
            deleteButton.textContent = 'ডিলিট';
            deleteButton.addEventListener('click', () => {
                deleteChannel(channelItem, channel);
            });
            
            const downloadButton = document.createElement('button');
            downloadButton.className = 'action-button download';
            downloadButton.textContent = 'ডাউনলোড';
            downloadButton.addEventListener('click', () => {
                downloadSingleChannel(channel);
            });

            const moveUpButton = document.createElement('button');
            moveUpButton.className = 'action-button move';
            moveUpButton.innerHTML = '&#9650;'; // Up arrow
            moveUpButton.addEventListener('click', (e) => {
                e.stopPropagation();
                moveChannel(channel, 'up');
            });
            
            const moveDownButton = document.createElement('button');
            moveDownButton.className = 'action-button move';
            moveDownButton.innerHTML = '&#9660;'; // Down arrow
            moveDownButton.addEventListener('click', (e) => {
                e.stopPropagation();
                moveChannel(channel, 'down');
            });
            
            actionsDiv.appendChild(playButton);
            actionsDiv.appendChild(deleteButton);
            actionsDiv.appendChild(downloadButton);
            actionsDiv.appendChild(moveUpButton);
            actionsDiv.appendChild(moveDownButton);

            channelItem.appendChild(logo);
            channelItem.appendChild(channelInfo);
            channelItem.appendChild(actionsDiv);
            
            channelListDiv.appendChild(channelItem);
            
            testChannel(channel, channelItem);
        });

        autoPlayBtn.style.display = 'block';
        downloadWorkingBtn.style.display = 'block';
        downloadAllBtn.style.display = 'block';
    }

    function playChannel(channel) {
        document.querySelectorAll('.channel-item').forEach(item => {
            item.classList.remove('playing');
        });
        const currentItem = Array.from(channelListDiv.children).find(item => item.dataset.name === channel.name);
        if (currentItem) {
            currentItem.classList.add('playing');
        }

        if (hls) {
            hls.destroy();
            hls = null;
        }
        videoPlayer.src = '';
        
        if (Hls.isSupported()) {
            hls = new Hls();
            hls.loadSource(channel.url);
            hls.attachMedia(videoPlayer);
            hls.on(Hls.Events.MANIFEST_PARSED, function() {
                videoPlayer.play();
            });
            hls.on(Hls.Events.ERROR, function(event, data) {
                console.error('HLS Error:', data);
                if (data.fatal) {
                    if (autoPlayBtn.textContent === 'অটো প্লে বন্ধ করুন') {
                        playNextChannel();
                    }
                }
            });
        } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
            videoPlayer.src = channel.url;
            videoPlayer.addEventListener('loadedmetadata', function() {
                videoPlayer.play();
            });
        } else {
            alert('দুঃখিত, আপনার ব্রাউজার এই ধরনের স্ট্রিম সমর্থন করে না।');
        }
    }
    
    function playNextChannel() {
        if (autoPlayBtn.textContent === 'অটো প্লে বন্ধ করুন' && workingChannels.length > 0) {
            currentPlayingIndex = (currentPlayingIndex + 1) % workingChannels.length;
            playChannel(workingChannels[currentPlayingIndex]);
        }
    }

    function testChannel(channel, channelItem) {
        const tempVideo = document.createElement('video');
        const hlsTest = new Hls();
        
        hlsTest.loadSource(channel.url);
        hlsTest.attachMedia(tempVideo);
        
        hlsTest.on(Hls.Events.MANIFEST_PARSED, function() {
            console.log(`${channel.name} is working.`);
            channelItem.classList.add('working');
            workingChannels.push(channel);
            hlsTest.destroy();
        });
        
        hlsTest.on(Hls.Events.ERROR, function(event, data) {
            console.error(`${channel.name} failed:`, data.details);
            hlsTest.destroy();
        });
    }

    function deleteChannel(channelItem, channelToDelete) {
        if (confirm('আপনি কি এই চ্যানেলটি মুছে ফেলতে চান?')) {
            allChannels = allChannels.filter(channel => channel.name !== channelToDelete.name);
            workingChannels = workingChannels.filter(channel => channel.name !== channelToDelete.name);
            channelItem.remove();
        }
    }

    function downloadSingleChannel(channel) {
        const m3uContent = `#EXTM3U\n#EXTINF:-1 tvg-id="" tvg-logo="${channel.logo}",${channel.name}\n${channel.url}\n`;
        const blob = new Blob([m3uContent], { type: 'audio/mpegurl' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${channel.name}.m3u`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
    
    function moveChannel(channelToMove, direction) {
        const oldIndex = allChannels.findIndex(channel => channel.name === channelToMove.name);
        if (oldIndex === -1) return;

        let newIndex = oldIndex;
        if (direction === 'up' && oldIndex > 0) {
            newIndex--;
        } else if (direction === 'down' && oldIndex < allChannels.length - 1) {
            newIndex++;
        } else {
            return;
        }

        // Swap channels in the allChannels array
        const [removedChannel] = allChannels.splice(oldIndex, 1);
        allChannels.splice(newIndex, 0, removedChannel);

        // Re-display the channels to reflect the new order
        displayChannels(allChannels);
    }
</script>

</body>
</html>